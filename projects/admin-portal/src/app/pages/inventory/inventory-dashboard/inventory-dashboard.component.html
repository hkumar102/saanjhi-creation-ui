<!-- Dashboard Header -->
<div class="flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-3xl font-bold text-900 m-0">Inventory Management</h1>
        <p class="text-600 mt-1">Monitor product availability, rental schedules, and inventory health.</p>
    </div>
    <div class="flex gap-2">
        <p-button label="Add Product" icon="pi pi-plus" severity="success" (onClick)="addProduct()" />
        <p-button label="Bulk Update" icon="pi pi-upload" severity="secondary" (onClick)="bulkUpdate()" />
    </div>
</div>

<!-- Key Metrics Row -->
<div class="grid mb-4">
    <div class="col-12 md:col-6 lg:col-3">
        <saanjhi-ui-metric-card title="Total Products" [value]="inventoryService.metrics().totalProducts.toString()"
            trend="+5" trendPeriod="vs last month" icon="pi pi-box" iconBackground="#3B82F6" />
    </div>

    <div class="col-12 md:col-6 lg:col-3">
        <saanjhi-ui-metric-card title="Available Now" [value]="inventoryService.metrics().availableProducts.toString()"
            [trend]="getAvailabilityTrend()" trendPeriod="products ready" icon="pi pi-check-circle"
            iconBackground="#10B981" />
    </div>

    <div class="col-12 md:col-6 lg:col-3">
        <saanjhi-ui-metric-card title="Currently Rented" [value]="inventoryService.metrics().rentedProducts.toString()"
            [trend]="getUtilizationTrend()" trendPeriod="utilization rate" icon="pi pi-calendar"
            iconBackground="#F59E0B" />
    </div>

    <div class="col-12 md:col-6 lg:col-3">
        <saanjhi-ui-metric-card title="Inventory Value"
            [value]="inventoryService.metrics().totalValue.toString() | appCurrency" trend="+12%"
            trendPeriod="vs last month" icon="pi pi-chart-line" iconBackground="#8B5CF6" />
    </div>
</div>

<!-- Alerts Row -->
<div class="grid mb-4" *ngIf="getAlerts().length > 0">
    <div class="col-12">
        <p-card header="Inventory Alerts" styleClass="border-left-3 border-orange-500">
            <div class="flex flex-wrap gap-2">
                <p-tag *ngFor="let alert of getAlerts()" [value]="alert.message" [severity]="alert.severity"
                    icon="pi pi-exclamation-triangle" />
            </div>
        </p-card>
    </div>
</div>

<!-- Charts and Quick Stats -->
<div class="grid mb-4">
    <div class="col-12 lg:col-8">
        <p-card header="Inventory Overview">
            <div class="grid">
                <!-- Utilization Chart -->
                <div class="col-12 md:col-6">
                    <saanjhi-ui-analytics-chart title="Product Utilization" chartType="doughnut"
                        [data]="getUtilizationChartData()" chartHeight="300px" />
                </div>

                <!-- Status Distribution -->
                <div class="col-12 md:col-6">
                    <saanjhi-ui-analytics-chart title="Status Distribution" chartType="bar"
                        [data]="getStatusChartData()" chartHeight="300px" />
                </div>
            </div>
        </p-card>
    </div>

    <div class="col-12 lg:col-4">
        <p-card header="Quick Actions" styleClass="h-full">
            <div class="flex flex-column gap-3">
                <p-button label="Schedule Maintenance" icon="pi pi-wrench" severity="warn" styleClass="w-full"
                    (onClick)="scheduleMaintenance()" />

                <p-button label="Stock Replenishment" icon="pi pi-plus-circle" severity="info" styleClass="w-full"
                    (onClick)="stockReplenishment()" />

                <p-button label="Generate Report" icon="pi pi-file-pdf" severity="secondary" styleClass="w-full"
                    (onClick)="generateReport()" />

                <p-button label="Export Inventory" icon="pi pi-download" severity="secondary" styleClass="w-full"
                    (onClick)="exportInventory()" />
            </div>
        </p-card>
    </div>
</div>

<!-- Inventory Table -->
<p-card header="Product Inventory">
    <div class="flex flex-column md:flex-row gap-3 mb-3">
        <!-- Search -->
        <div class="flex-auto">
            <span class="p-input-icon-left w-full">
                <i class="pi pi-search"></i>
                <input type="text" pInputText placeholder="Search products..." [(ngModel)]="searchTerm"
                    (input)="onSearch()" class="w-full" />
            </span>
        </div>

        <!-- Status Filter -->
        <p-dropdown [options]="statusOptions" [(ngModel)]="selectedStatus" placeholder="Filter by status"
            (onChange)="onStatusFilter()" [showClear]="true" />

        <!-- Category Filter -->
        <p-dropdown [options]="categoryOptions" [(ngModel)]="selectedCategory" placeholder="Filter by category"
            (onChange)="onCategoryFilter()" [showClear]="true" />
    </div>

    <p-table [value]="filteredInventory" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]"
        [loading]="inventoryService.loading()" responsiveLayout="scroll"
        [globalFilterFields]="['product.name', 'product.category.name']">

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="product.name">
                    Product <p-sortIcon field="product.name"></p-sortIcon>
                </th>
                <th pSortableColumn="status">
                    Status <p-sortIcon field="status"></p-sortIcon>
                </th>
                <th pSortableColumn="availableQuantity">
                    Available <p-sortIcon field="availableQuantity"></p-sortIcon>
                </th>
                <th pSortableColumn="rentedQuantity">
                    Rented <p-sortIcon field="rentedQuantity"></p-sortIcon>
                </th>
                <th pSortableColumn="totalQuantity">
                    Total <p-sortIcon field="totalQuantity"></p-sortIcon>
                </th>
                <th pSortableColumn="availabilityRate">
                    Utilization <p-sortIcon field="availabilityRate"></p-sortIcon>
                </th>
                <th pSortableColumn="revenue">
                    Revenue <p-sortIcon field="revenue"></p-sortIcon>
                </th>
                <th>Actions</th>
            </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
                <td>
                    <div class="flex align-items-center gap-3">
                        <img *ngIf="item.product.imageUrl" [src]="item.product.imageUrl" [alt]="item.product.name"
                            class="border-round" style="width: 40px; height: 40px; object-fit: cover;" />
                        <div class="flex flex-column">
                            <span class="font-semibold">{{ item.product.name }}</span>
                            <small class="text-600">{{ item.product.category?.name }}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <p-tag [value]="getStatusLabel(item.status)" [severity]="getStatusSeverity(item.status)"
                        [icon]="getStatusIcon(item.status)" />
                </td>
                <td>
                    <span class="font-bold text-green-600">{{ item.availableQuantity }}</span>
                </td>
                <td>
                    <span class="font-bold text-orange-600">{{ item.rentedQuantity }}</span>
                </td>
                <td>
                    <span class="font-bold">{{ item.totalQuantity }}</span>
                </td>
                <td>
                    <div class="flex align-items-center gap-2">
                        <p-progressBar [value]="100 - item.availabilityRate" [style]="{ width: '60px', height: '8px' }"
                            [color]="getUtilizationColor(item.availabilityRate)">
                        </p-progressBar>
                        <small>{{ (100 - item.availabilityRate).toFixed(0) }}%</small>
                    </div>
                </td>
                <td>
                    <span class="font-semibold">{{ item.revenue | appCurrency }}</span>
                </td>
                <td>
                    <div class="flex gap-1">
                        <p-button icon="pi pi-eye" size="small" severity="info" pTooltip="View Details"
                            (onClick)="viewDetails(item)" />

                        <p-button icon="pi pi-pencil" size="small" severity="secondary" pTooltip="Edit Product"
                            (onClick)="editProduct(item)" />

                        <p-button icon="pi pi-calendar" size="small" severity="success" pTooltip="View Schedule"
                            (onClick)="viewSchedule(item)" />

                        <p-button *ngIf="item.status !== 'maintenance'" icon="pi pi-wrench" size="small" severity="warn"
                            pTooltip="Schedule Maintenance" (onClick)="scheduleProductMaintenance(item)" />
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-box text-4xl text-400"></i>
                        <span class="text-600">No products found</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</p-card>

<!-- Product Details Dialog -->
<p-dialog header="Product Details" [(visible)]="showDetailsDialog" [modal]="true"
    [style]="{ width: '80vw', maxWidth: '800px' }" [closable]="true">

    <div *ngIf="selectedProduct" class="grid">
        <div class="col-12 md:col-6">
            <h4>Product Information</h4>
            <div class="field-group">
                <label>Name:</label>
                <span class="font-semibold">{{ selectedProduct.product.name }}</span>
            </div>
            <div class="field-group">
                <label>Category:</label>
                <span>{{ selectedProduct.product.categoryName }}</span>
            </div>
            <div class="field-group">
                <label>Rental Price:</label>
                <span>{{ selectedProduct.product.rentalPrice | appCurrency }}</span>
            </div>
        </div>

        <div class="col-12 md:col-6">
            <h4>Inventory Status</h4>
            <div class="field-group">
                <label>Total Quantity:</label>
                <span class="font-semibold">{{ selectedProduct.totalQuantity }}</span>
            </div>
            <div class="field-group">
                <label>Available:</label>
                <span class="text-green-600 font-semibold">{{ selectedProduct.availableQuantity }}</span>
            </div>
            <div class="field-group">
                <label>Currently Rented:</label>
                <span class="text-orange-600 font-semibold">{{ selectedProduct.rentedQuantity }}</span>
            </div>
        </div>

        <div class="col-12">
            <h4>Current Rentals</h4>
            <p-table [value]="selectedProduct.currentRentals" [rows]="5">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Customer</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Amount</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-rental>
                    <tr>
                        <td>{{ rental.customer?.name }}</td>
                        <td>{{ rental.startDate | date: 'shortDate' }}</td>
                        <td>{{ rental.endDate | date: 'shortDate' }}</td>
                        <td>{{ rental.rentalPrice | appCurrency }}</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</p-dialog>